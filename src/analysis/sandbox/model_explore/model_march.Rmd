---
title: "Preliminary wsb layer"
output: 
  html_document:
    highlight: zenburn
    code_folding: hide
    toc: true
    # toc_float: true
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, out.width = "100%")

# datatable style
dt_make <- function(x){
  x %>% 
    DT::datatable(
    rownames = FALSE, 
    extensions = 'Buttons', 
    options = list(
      dom = 'Bfrtip', 
      buttons = c('copy', 'csv', 'excel')
    )
  )
}
```

*Jess Goddard & Rich Pauloo*

*Last updated `r Sys.time()`*

<br>  

# Introduction

Herein, we present a preliminary approach to create a nationwide water service spatial boundary layer for community water systems. Importantly, this report builds on a previous report `eda_february.html` that should be read first for background, context, and exploratory data analysis (EDA) that informs the approach taken in the work described in this report. 

The national water service boundary layer (henceforth, **wsb**) is created in three tiers, arranged by data and model fidelity. 

```{r load}
library(tidyverse)
library(tidymodels)
library(sf)
library(fs)

staging_path <- Sys.getenv("WSB_STAGING_PATH")
epsg_aw      <- Sys.getenv("WSB_EPSG_AW")
epsg         <- as.numeric(Sys.getenv("WSB_EPSG"))

d <- read_csv(path(staging_path, "matched_output_clean.csv"))
```


# Report outline


# EDA

Response variable (radius) is log-normal.

```{r}
d %>% 
  ggplot(aes(radius/1000)) + 
  geom_histogram(bins = 50, col= "white") +
  labs(x = "Radius (km)")

d %>% 
  ggplot(aes(radius/1000)) + 
  geom_histogram(bins = 50, col= "white") + 
  scale_x_log10() +
  labs(x = "Radius (km)")
```

Population served and service connections are highly correlated ~ 0.83

```{r}
cor.test(d$population_served_count, d$service_connections_count)

d %>% 
  ggplot(aes(population_served_count/1e6, service_connections_count/1e3)) + 
  geom_point(alpha = 0.3) + 
  labs(x = "Poulation served (millions)", 
       y = "Service connections (thousands)")
```


# Limitations

1. We lack labeled data and hence radii for tribal primacy types (and territories), and can't improve the model based on this information until we collect is.  

```{r}
d %>% 
  group_by(primacy_type) %>% 
  summarise(proportion_present = sum(!is.na(radius))/n(),
            proportion_present = round(proportion_present, 2)) %>% 
  dt_make()
```


# Recommendations and next steps

- Gather labeled boundaries for tribal primacy type (and territories if coverage is to be extended to these regions). 

