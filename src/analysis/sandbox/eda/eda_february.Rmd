---
title: "EDA: water system boundary missingness, quality, & coverage"
output: 
  html_document:
    highlight: zenburn
    code_folding: hide
    toc: true
    # toc_float: true
    toc_depth: 3
    number_sections: true
    # css: etc/style/style.css
# bibliography: etc/references.bib  
# link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, out.width = "100%")
```

*Jess Goddard & Rich Pauloo*

*Last updated `r Sys.time()`*


# Introduction

Presently, over 50,000 community water systems in the United States collectively serve tap water to approximately **<X>** people. These water systems cross-cut racial/ethnic, income, and political boundaries, yet despite their importance, up-to-date, easily accessible boundary data (i.e., spatial polygons that delineate water service boundaries) are not organized at the national level. State-level data may exist, but these data tend to be hard to find online, may require cleaning, and little is known on the completeness of these data. Hence, national-scale analyses cannot proceed without a national-level spatial database of community water systems. The overarching goal of this [project](https://github.com/SimpleLab-Inc/wsb) is to assemble the nation's first open-source, reproducible pipeline to assimilate existing water service boundary data; where existing spatial data does not exist, we use a combination of data assimilation and machine learning to assign and predict proxy boundaries. To service this goal, a variety of state and federal data sources must be cleaned, analyzed, joined, and ultimately, modeled. Moreover, this technical work effort takes place in the context of stakeholder communication and engagement, and additional data collection efforts. In this report, we investigate data quality issues in state and federal data to:  

1. assess data "missingness" (e.g., missing water system boundary polygons, and `NA` or `NULL` values which will impact data collection efforts, and the ability to model missing data)  
2. examine data quality (e.g., do data actually represent what they report to represent?) to inform future data collection and cleaning efforts and gauge the appropriateness of modeling with existing data  
3. review data coverage by various features of water systems (e.g., system size, system type, tribal designation, population served) to inform future data collection and cleaning efforts, and understand potential model limitations  


_Missingness_
- [ ] Existing coverage of spatial labeled data
- [ ] Coverage of centroids
- [ ] Tabular data: assess missingness for key categories (i.e., population served, system size AKA connection count)

_Data Quality_
- [ ] Number of "imposter" centroids across datasets (echo, frs, mhp)
- [ ] Centroids of low quality (e.g. `fac_collection_method` is state or county centroid). break down by state, system size (?) -> when we don't have labeled boundary or TIGRIS, collection method is really important, we need to characterize how big this group is and where they plot, and how to address them.
- [ ] Appropriateness of TIGRIS boundaries as proxy. Compare join for labeled systems: e.g., city of Davis, and Davis TIGRIS places -> boolean T/F and jacard (less important)

_Coverage relative to SDWIS master list of active, community water systems_
- [ ] Summary of existing boundary coverage by system size (using [EPA categories](https://echo.epa.gov/help/drinking-water-dashboard-help))
- [ ] Summary of existing boundary coverage by system type (Municipal, etc) / ownership type
- [ ] Summary of existing boundary coverage by tribal vs non-tribal (i.e. primacy_type_code is territory?)
- [ ] Total US population served by existing boundary date (using SDWIS provided `population_served`)


# Missingness

We examine missingness of key datasets in terms of:

- **The existing coverage of "labeled" service boundaries.** "Labeled" service boundaries refer to spatial polygons of existing data and stand in contrast to "unlabeled" data, which are water systems _without_ explicit spatial polygons and for which we must estimate a boundary.  
- **Centroid coverage.** For unlabeled data, we must estimate a boundary, and the model we will develop will estimate the radius of a water system boundary from a centroid. Thus we need spatial centroids for unlabeled data. Sometimes thee centroids are provided, sometimes not. We assess their coverage nationwide.  
- **Tabular data missingness.** Tabular data is non-spatial data associated with water systems (e.g., population served, system size) that can be used to predict water system radii. Missingness in these columns may limit the extensibility of modeling and is thus characterized.  


## Existing coverage of spatial labeled data


```{r}
library(tidyverse)
library(here)
library(fs)
library(sf)
library(mapview)
library(rcartocolor)
library(geofacet)

mapviewOptions(fgb = FALSE)

# data input location for EDA is the post-transformer staging path
staging_path <- Sys.getenv("WSB_STAGING_PATH")
epsg         <- as.numeric(Sys.getenv("WSB_EPSG"))

# previously run to generate a small data file for plotting, then save
# wsb_labeled <- st_read(path(staging_path, "wsb_labeled.geojson")) %>% 
#   rmapshaper::ms_simplify()
# dir_create(here("etc"))
# write_rds(wsb_labeled, here("etc/wsb_labeled_simplified.rds"))

# load existing labeled data and simply it for viewing
wsb_labeled_simp <- read_rds(here("etc/wsb_labeled_simplified.rds"))
```

Labeled spatial data (i.e.,m spatial polygons present) are present for `r nrow(wsb_labeled_simp)` PWSIDs that cover `r length(unique(wsb_labeled_simp$state))` states: `paste(unique(wsb_labeled_simp$state), collapse = ", ")`. Due to constraints on visualizing the large number of vertices in these polygon data, the map shown below provides a low-resolution version of the labeled data, with only ~5% of vertices, but analyses all use the high-resolution version.  

```{r, echo=FALSE}
wsb_labeled_simp %>% 
  select(pwsid, gis_name) %>% 
  mapview(layer.name = "labeled wsb")
```

Labeled data is always preferred to unlabeled data. The assimilation of labeled data from all states would replace the modeling stage of this study, which aims to estimate water service boundaries for unlabeled data in their absence. Thus, data collection efforts should be prioritized for missing states (below).  

```{r}
# summarise missing and present states in a dataframe
states_missing <- state.abb[!state.abb %in% unique(wsb_labeled_simp$state)]
states_present <- unique(wsb_labeled_simp$state)

states_df <- tibble(
  state_abbr = c(states_missing, states_present),
  status = c(rep("missing", length(states_missing)), 
             rep("present", length(states_present)))
)

# pull usa state geometries, project to input data CRS
usa <- USAboundaries::us_states(resolution = "low") %>% 
  st_transform(epsg) %>% 
  left_join(states_df) %>% 
  tigris::shift_geometry() %>% 
  # remove peurto rico
  filter(!is.na(status))

# map of missing states
ggplot() +
  geom_sf(data = usa, aes(fill = status), alpha = 0.5, color = "white") +
  scale_fill_carto_d(palette = "Pastel") +
  labs(fill = "") +
  theme_void() + 
  labs(title = "Labeled data coverage by state",
       subtitle = paste("Last updated:", Sys.Date()))

# data table with buttons to export table
states_df %>% 
  filter(!is.na(state_abbr)) %>% 
  arrange(status, state_abbr) %>% 
  DT::datatable(
    rownames = FALSE, 
    extensions = 'Buttons', 
    options = list(
      dom = 'Bfrtip', 
      buttons = c('copy', 'csv', 'excel')
    )
  )
```

> **RECCOMENDATION:** we should collect as many upstream labeled data sources from missing states which will increase the completeness of the overall labeled dataset and improve predicted boundaries.  


## Centroid coverage

Preliminary investigation of ECHO and FRS datasets showed that ECHO contained more centroid data, thus ECHO centroid coverage is assessed. As stated before, in this analysis we only focus on CWS. 

```{r}
# j stands for joined data, read and rm rownumber column
j <- read_csv(path(staging_path, "matched_output.csv"), col_select = -1)
```

First, `r round((nrow(filter(j, is.na(echo_latitude) | is.na(echo_longitude))) / nrow(j))*100, 2)`% of pwsids (`r nrow(filter(j, is.na(echo_latitude) | is.na(echo_longitude)))` / `r nrow(j)` ) are missing either a longitude or latitude (i.e., the x or y coordinate is `NA`). 

For the remaining systems that are "complete" in the sense that they have a spatial centroid, we now seek to understand how accurate that centriod is. Most centroids are derived from the county centroid, address matching on a house number, or a zip code centroid. County- and state-level centroids are of little use as these data offer low to little indication of the true pwsid location. Any method that appears less then 5% of the time is lumped into "other".

```{r}
# joined data that is "complete" in the sense that it has a lng/lat
jc <- filter(j, !is.na(echo_latitude) & !is.na(echo_longitude))

jc %>% 
  # anything that appears less then 5% of the time is lumped into "other"
  mutate(echo_geocode_method = fct_lump_prop(echo_geocode_method, 0.05)) %>%
  count(echo_geocode_method) %>% 
  ggplot(aes(fct_reorder(echo_geocode_method, n), n)) + 
  geom_col() + 
  coord_flip() +
  labs(x = "", y = "Count", title = "ECHO geocoding method")
```

Centroid geocoding method varies by state. Most states primarily derive centroid from county centroids(e.g., VT, NH, NY, SD, NJ, UT, CO, and so on - see blue bars in plot below), and others primarily derive centroids from interpolation photos (e.g., WA, ID, OR, AK - see pink bars in plot below). 

```{r}
# summary proportion of geocoding method by state
jcs <- jc %>% 
  # anything that appears less then 5% of the time is lumped into "other"
  mutate(echo_geocode_method = fct_lump_prop(echo_geocode_method, 0.05)) %>%
  group_by(state_code, echo_geocode_method) %>% 
  summarise(n = n()) %>% 
  mutate(p = n / sum(n)) %>% 
  mutate(echo_geocode_method = case_when(
    echo_geocode_method == "ADDRESS MATCHING-HOUSE NUMBER" ~ "address match",
    echo_geocode_method == "INTERPOLATION-PHOTO"           ~ "interp photo",
    echo_geocode_method == "County Centroid"               ~ "centroid county",
    echo_geocode_method == "State Centroid"                ~ "centroid state",
    echo_geocode_method == "Zip Code Centroid"             ~ "centroid zip",
    echo_geocode_method == "Other"                         ~ "other",
    TRUE ~ NA_character_
  )) %>% 
  ungroup()
  
jcs %>% 
  filter(!is.na(state_code)) %>% 
  ggplot(aes(fct_reorder(echo_geocode_method, p), p, 
             fill = echo_geocode_method)) + 
  geom_col() + 
  coord_flip() +
  scale_fill_carto_d() +
  scale_y_continuous(breaks = c(0, 0.5, 1),
                     labels = c(0, 0.5, 1),
                     limits = c(0, 1)) +
  geofacet::facet_geo(~state_code) +
  labs(x = "", y = "Proportion", 
       title = "ECHO geocoding method") +
  guides(fill = "none") +
  theme_minimal(base_size = 6) +
  theme(panel.grid.minor = element_blank())
```

In the plots above, any method that appeared less then 5% of the time was lumped into "other", and in the table below, we show all methods, sorted by occurrence.  

```{r}
jc %>% 
  count(echo_geocode_method) 
  
```


## Tabular data missingness: assess missingness for key categories (i.e., population served, system size AKA connection count)

# Recommendations and next steps
