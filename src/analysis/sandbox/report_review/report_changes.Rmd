---
title: 'Review of TEMM layer Results'
output: 
  bookdown::html_document2:
    highlight: zenburn
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
    # number_sections: true
---

```{=html}
<style type="text/css">
  /* Whole document: */
  body{
    font-family: Helvetica;
    font-size: 13pt;
  }
  /* Headers */
  h1{
    font-size: 36pt;
  }
  h2{
    font-size: 30pt;
  }
  h3{
    font-size: 24pt;
  }
  h4{
    font-size: 18pt;
  }
  h5{
    font-size: 14pt;
  }
}

</style>
```

```{r setup, echo=FALSE, message = FALSE}
library(knitr)
library(here)
library(ggplot2)

# env vars
epsg <- as.numeric(Sys.getenv("WSB_EPSG"))

# global chunk options
opts_chunk$set(warning = FALSE, message = FALSE, out.width = "100%")

# outputs a customized HTML datatable with buttons
dt_make <- function(x){
  x %>% 
    DT::datatable(
    rownames = FALSE, 
    extensions = 'Buttons', 
    options = list(
      dom = 'Bfrtip', 
      buttons = c('copy', 'csv', 'excel')
    )
  )
}

# function to add consistent, auto-numbered table captions for DT objects
f_make_caption <- function(tag, caption){
  cat(
    "<table width=100%>",
    paste0("<caption>", 
           "(#tab:", tag, ")", 
           caption,
           "</caption>"),
    "</table>"
  )
}

# converts a float to a string with appropriate commas
format_bign <- function(x) formatC(x, big.mark = ",", format = "d")

# ggplot2 report theme
theme_report <- theme_minimal() + theme(panel.grid.minor = element_blank())
```


# Report setup

```{r read-temm}
library(tidyverse)
library(sf)
library(fs)
library(rcartocolor)
library(geofacet)
library(mapview)

# don't allow fgb streaming: delivers self-contained html
mapviewOptions(fgb = FALSE)

# load environmental variable for staging path 
staging_path <- Sys.getenv("WSB_STAGING_PATH")
output_path <- Sys.getenv("WSB_OUTPUT_PATH")

# read TEMM spatial output for key resul summary stats below
temm <- dir_ls(path(output_path, "temm_layer/"), glob = "*geojson") %>% 
  # get the most up to date temm spatial geojson layer if there are many
  sort() %>% rev() %>% .[1] %>% 
  st_read(quiet = TRUE) %>% 
  # drop this column because it's read as a list and causes mapview trouble
  select(-service_area_type_code)

# total count of water systems that are assigned _some_ tier
nrow_d <- temm %>% drop_na(tier) %>% nrow()

# Tier 1 labeled data
wsb_labeled_clean <- path(staging_path, "wsb_labeled_clean.geojson") %>% 
  st_read(quiet = TRUE)

# read the clean matched output and perform minor transforms for plots.
# this has the same number of rows as `temm`, but contains Tier 1 "radius"
matched_input <- read_csv(path(staging_path, "model_input_clean.csv")) %>%
  mutate(
    # transform radius from m to km
    radius = radius/1000) 

# combine to get complete list
d <- matched_input %>%
  left_join(temm %>%
              select(pwsid, tier), on = "pwsid") %>%
  select(-geometry)

# population served by all water systems
# Note there are systems with missing population, ignore
pop_total <- sum(d$population_served_count, na.rm = TRUE)

# calculate count and proportion of people served by each tier
pop <- d %>% 
  filter(!is.na(population_served_count)) %>%
  group_by(tier) %>% 
  summarize(
    count = format_bign(sum(population_served_count)),
    prop  = round((sum(population_served_count)/pop_total)*100, 2)
  )

# read in sdwis original set of water systems for comparisons
acws <- read_csv(path(staging_path, "sdwis_water_system.csv")) %>%
  filter(pws_activity_code == "A" &
           pws_type_code == "CWS")

# number of active, community water systems in SDWIS
n_acws <- acws %>% nrow()

# population served by active, community water systems in SDWIS
pop_acws <- sum(acws$population_served_count)

# get full list of temm systems (incl those without population), "a" for all
a <- temm

# remove geometry
st_geometry(a) <- NULL

# calculate count and proportion of water systems by each tier 
sys <- a %>% 
  group_by(tier) %>% 
  summarize(
    count = n(),
    prop  = round((sum(count)/n_acws)*100, 2)
  )

```

***Key Results***

-   A nationwide water service boundary layer is provided for `r format_bign(nrow_d)` community water systems[^1] covering a total population of `r format_bign(pop_total)`.\
-   Population coverage rates per Tier, for systems with population reported:
    -   *Tier 1*: `r pop$prop[1]`% population covered (`r pop$count[1]` people)\
    -   *Tier 2*: `r pop$prop[2]`% population covered (`r pop$count[2]` people)\
    -   *Tier 3*: `r pop$prop[3]`% population covered (`r pop$count[3]` people)\
-   CWS coverage rates per Tier:
    -   *Tier 1*: `r sys$prop[1]`% system covered (`r sys$count[1]` systems)\
    -   *Tier 2*: `r sys$prop[2]`% system covered (`r sys$count[2]` systems)\
    -   *Tier 3*: `r sys$prop[3]`% system covered (`r sys$count[3]` systems)\
    -   *No Tier/Geometry*: `r sys$prop[4]`% system covered (`r sys$count[4]` systems)
-   The distribution of population in each of these Tiers varies by state (see [state-level coverage map](#Tier_coverage_-_statewide)).\
-   Favorable uncertainty metrics for Tier 2 and 3 estimates suggest that the TEMM approach provides a reasonable preliminary water service boundary layer.

[^1]: We drop `r sys$count[1]`/`r print(n_acws)` (`r sys$prop[1]`%) of water systems from this analysis for one of three reasons: (i) they lack a latitude or longitude (and hence we cannot "center" them anywhere), (ii) they fall outside of the 50 US States (e.g., territories like Puerto Rico, Guam, American Samoa), or (iii) their reported population or service connection count is less than 15, which is the minimum service connection count required for a system to be classified as a "community water system".


## Tier coverage - nationwide

In total, the TEMM data layer represents tap water delivery to `r round(pop_total/1e6, 2)` million people served by `r format_bign(nrow_d)` water systems. This amounts to `r round(pop_total/pop_acws*100,2)`% of the population reportedly served by active community water systems in SDWIS and `r round(nrow_d/n_acws*100,2)`% of active community water systems in SDWIS. Note that some systems report population of 0 or 1; these are wholesalers and therefore there is some inaccuracy around the total counts for population served and total population.

About `r str_sub(pop$count, 1, 3)[1]` million people are covered by Tier 1 spatial data -- impressive given that only `r wsb_labeled_clean$state %>% unique() %>% length()` states that provided explicit boundary data. However, this relatively high coverage rate is unsurprising because these states (`r wsb_labeled_clean$state %>% unique() %>% sort() %>% paste(collapse = ", ")`) include notable centers of high-population like CA, TX, and PA.

Together, around `r str_sub(sum((as.numeric(str_remove_all(pop$count[1:2], ",")))), 1, 3)` million people (`r sum(pop$prop[1:2])`% of the population) are covered by either a Tier 1 or a Tier 2 spatial boundary. The remaining approximately `r str_sub((as.numeric(str_remove_all(pop$count[3], ","))), 1, 2)` million people (`r sum(pop$prop[3])`%) represented in the layer are covered by a less accurate, Tier 3 boundary. These results indicate relatively high confidence in the spatial accuracy of the resulting TEMM water boundary layer for a majority of the population served by community water systems.

```{r temm-nationwide-pop-kable}
pop %>% 
  kable(col.names = c("Tier", "Population count", 
                      "Population proportion (%)"), 
        align = rep("l", 3),
        caption = "Population coverage by tier (for systems with population reported)") %>% 
  kableExtra::kable_styling(full_width = FALSE)
```

Together, around `r sum(sys$count[2:3])` community water systems (`r sum(sys$prop[2:3])`% of systems in layer) are covered by either a Tier 1 or a Tier 2 spatial boundary. Approximately `r sum(sys$count[4])` water systems (`r sum(sys$prop[4])`%) are covered by a Tier 3 boundary. There are `r sum(sys$count[1])` systems (`r sum(sys$prop[1])`%) of systems have *no* geometry associated with them and are therefore not represented in the final TEMM layer.

```{r temm-nationwide-cws-kable}
sys %>% 
  kable(col.names = c("Tier", "CWS\ncount", 
                      "CWS\nproportion (%)"), 
        align = rep("l", 3),
        caption = "Community water system (CWS) coverage by tier") %>% 
  kableExtra::kable_styling(full_width = FALSE)
```

<br>

## Tier coverage - statewide

Next, we show the proportion of population covered in the *final spatial layer* per TEMM Tier on a state-by-state basis. Notably:

-   When Tier 1 data is present (grey bars below), it tends to cover a majority of the population.\
-   Together, Tiers 2/2b (teal and dark blue bars below) cover more population than Tier 3 across nearly all states. In some states, Tier 2 is more common than Tier 2b.\
-   Tier 3 coverage (orange bars below) is not uniform across states. This implies that the Tier 2 matching algorithm may perform better in some states, and may depend on factors that vary across states, like centroid accuracy and water system type (e.g., municipal).

```{r geofacet-temm-tier-distribution-per-state, fig.cap = "TEMM Tier distribution by state"}
# state pop from full sdwis list
state_pop <- acws %>%
  group_by(primacy_agency_code) %>%
  summarize(state_pop = sum(population_served_count))

# dataframe for barplot geofacet: population prop served by each tier
# using all systems
ag <- a %>% 
  group_by(primacy_agency_code, tier) %>% 
  left_join(state_pop, on = "primacy_agency_code") %>%
  # calculate count/proportion of population served per state and tier
  summarise(
    count = sum(population_served_count, na.rm = TRUE),
    prop  = count/state_pop
  ) %>% 
  ungroup() %>% 
  distinct() %>% 
  # add missing NA values per state code and tier group
  complete(primacy_agency_code, tier,
           fill = list(count = 0, prop = 0)) 

# sanity check the grouped summary above: this should return all 1
# group_by(ag, primacy_agency_code) %>% 
#  summarise(s = sum(prop, na.rm = TRUE)) %>% 
#  pull(s) 

# geofacet of TEMM tier coverage per state in terms of population proportion
ag %>% 
  ggplot(aes(fct_rev(as.factor(tier)), prop, fill = as.factor(tier))) + 
  geom_col() + 
  coord_flip() +
  scale_fill_carto_d(direction = -1) +
  scale_y_continuous(breaks = c(0, 1, 0.5), 
                     labels = c(0, 1, 0.5)) +
  geofacet::facet_geo(~primacy_agency_code) +
  labs(x = "", y = "Proportion of Population Covered") +
  guides(fill = "none") +
  theme_minimal(base_size = 6) +
  theme(panel.grid.minor.x = element_blank())
```

Native American water systems are designated in their water system id (pwsid) by their respective EPA region. For a full map of EPA regions see [here](https://www.epa.gov/aboutepa/regional-and-geographic-offices). Below we show that most of these systems lack Tier 1 data and have generally higher proportion of Tier 3 data compared to state primacy codes.

```{r facet-temm-distribution-native-american, fig.cap = "TEMM Tier distribution of systems in Native American territories-by EPA agency"}
ag %>% 
  # filter to Native American primacy codes
  filter(! primacy_agency_code %in% c(state.abb, "DC")) %>% 
  ggplot(aes(fct_rev(as.factor(tier)), prop, fill = as.factor(tier))) + 
  geom_col() + 
  coord_flip() +
  scale_fill_carto_d(direction = -1) +
  scale_y_continuous(breaks = c(0, 1, 0.5), 
                     labels = c(0, 1, 0.5)) +
  facet_wrap(~primacy_agency_code) +
  labs(x = "", y = "Proportion of Population Covered") +
  guides(fill = "none") +
  theme_minimal(base_size = 6) +
  theme(panel.grid.minor.x = element_blank())

# Data on number of native american territory systems overall vs. final set
nam_rep <- d %>% filter(! primacy_agency_code %in% c(state.abb, "DC"),
                        ! primacy_agency_code %in% c("PR", "VI", "NN", "AS", "MP", "GU")) %>% nrow()
nam <- acws %>% filter(! primacy_agency_code %in% c(state.abb, "DC"), 
                ! primacy_agency_code %in% c("PR", "VI", "NN", "AS", "MP", "GU")) %>% nrow()
```

<br>

In total, of the `r nam` systems in Native American territories nationwide, the final database after data loss due to missing centroids represents `r nam_rep` (`r round(nam_rep/nam*100,2)`%) systems in Native American territories. A data table of the the above plots is provided below.

```{r datatable-temm-tier-distribution-per-state, echo = FALSE}
f_make_caption("datatable-temm-tier-distribution-per-state",
               "TEMM tier distribution by state")

ag %>% 
  mutate(
    prop  = ifelse(is.na(prop), 0, prop),
    prop  = round(prop, 3)
  ) %>% 
  dt_make()
```

<br>

## Tier coverage - system size

Next, for each state, we quantify the proportion of systems in each Tier by water size based on population categories according to [EPA guidelines](https://echo.epa.gov/help/drinking-water-dashboard-help#:~:text=Very%20Small%20%C2%A0%20%C2%A0%20%C2%A0%20500,Very%20Large%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%20%3E100%2C000){target="_blank"}:

```{r epa-sys-size}
tribble(
~`EPA classification`, ~`Population Size`,
 "Very Small",            "500 or less",
 "Small",                 "501 - 3,300",
 "Medium",                "3,301 - 10,000",
 "Large",                 "10,001 - 100,000",
 "Very Large",            ">100,000"
) %>% 
  kable(align = rep("l", 2),
        caption = "EPA system size categorization") %>% 
  kableExtra::kable_styling(full_width = FALSE)
```

In states that lack Tier 1 boundaries, "Very Small" and "Small" systems tend to have higher proportions of Tier 3 boundaries (grey bars) compared to larger systems. This result is unsurprising because Tier 2 spatial matches hinge on connecting water systems to Census "Places" which tend to be more populous areas. We therefore expect that smaller systems lack a Tier 2 match, and are hence covered by Tier 3 boundaries. When Tier 1 data is present, it seems to cover all system sizes (i.e., CA, NJ, TX), with a slight bias towards covering larger systems (e.g., OK, WA, CT).

```{r temm-statewide-system-size, fig.cap = "TEMM Tier distribution by system size"}
# water system size levels in table above
size_lvls <- c("Missing Pop.", "Very Small", "Small", "Medium", "Large", "Very Large")

# dataframe for barplot geofacet: prop of each each tier per size class
ag2 <- a %>% 
  mutate(
    size_class = case_when(
      # in 99% of cases, pop served = 0 or 1 indicates wholesaler, but reporting as "missing pop"
      population_served_count == 0 | population_served_count == 1 ~ "Missing Pop.",
      population_served_count <= 500 ~ "Very Small",
      population_served_count > 500 & population_served_count <= 3300 ~ "Small",
      population_served_count > 3300 & population_served_count <= 10000 ~ "Medium",
      population_served_count > 10000 & population_served_count <= 100000 ~ "Large",
      population_served_count > 100000 ~ "Very Large"),
    size_class = factor(size_class, levels = size_lvls)
  ) %>% 
  group_by(primacy_agency_code, size_class) %>%
  # total count of tiers per state and size class
  mutate(size_class_count = n()) %>%
  ungroup() %>% 
  group_by(primacy_agency_code, size_class, tier) %>% 
  # calculate count/proportion of tiers per state and size class
  summarise(
    count = n(),
    prop  = count/size_class_count
  ) %>% 
  ungroup() %>% 
  distinct() %>% 
  # add missing NA values per state code and tier group
  complete(primacy_agency_code, size_class, tier, 
           fill = list(count = 0, prop = 0)) 

# geofacet of TEMM tier coverage per state in terms of population proportion
ag2 %>% 
  ggplot(aes(size_class, prop, fill = as.factor(tier))) + 
  geom_col(position = "stack") + 
  coord_flip() +
  scale_fill_carto_d(direction = -1) +
  scale_y_continuous(breaks = c(0, 1, 0.5), 
                     labels = c(0, 1, 0.5)) +
  geofacet::facet_geo(~primacy_agency_code) +
  labs(x = "", 
       y = "Proportion of Systems Covered by Each Tier, Split by System Size",
       subtitle = "Missing Pop indicates recorded population of 0 or 1, usually wholesaler",
       fill = "Tier") +
  theme_minimal(base_size = 6) +
  theme(panel.grid.minor.x = element_blank(), legend.position = c(0.95, 0.15))
```

Repeating the above analysis for primacy codes indicating Native American territories, we see that Native American systems are generally small or very small according to EPA size classification.

```{r temm-statewide-system-size-native-american, fig.cap = "TEMM Tier distribution of systems in Native American territories-by system size"}
ag2 %>% 
  filter(! primacy_agency_code %in% c(state.abb, "DC")) %>% 
  ggplot(aes(size_class, prop, fill = as.factor(tier))) + 
  geom_col(position = "stack") + 
  coord_flip() +
  scale_fill_carto_d() +
  scale_y_continuous(breaks = c(0, 1, 0.5), 
                     labels = c(0, 1, 0.5)) +
  facet_wrap(~primacy_agency_code) +
  labs(x = "", 
       y = "Proportion of Systems Covered by Each Tier, Split by System Size (Population)",
       subtitle = "Missing Pop indicates recorded population of 0 or 1, usually wholesaler",
       fill = "Tier") +
  theme_minimal(base_size = 6) +
  theme(panel.grid.minor.x = element_blank())
```

<br>

A data table of Tier categories across system sizes, nationwide, is provided below. Proportion represents the proportion of Tier within the size class.

```{r datatable-temm-tier-distribution-by-system-size, echo = FALSE}
f_make_caption("datatable-temm-tier-distribution-by-system-size",
               "TEMM Tier distribution by system size")

# dataframe for barplot geofacet: prop of each each tier per size class
a %>% 
  mutate(
    size_class = case_when(
      # in 99% of cases, pop served = 0 or 1 indicates wholesaler, but reporting as "missing pop"
      population_served_count == 0 | population_served_count == 1 ~ "Missing Pop.",
      population_served_count <= 500 ~ "Very Small",
      population_served_count > 500 & population_served_count <= 3300 ~ "Small",
      population_served_count > 3300 & population_served_count <= 10000 ~ "Medium",
      population_served_count > 10000 & population_served_count <= 100000 ~ "Large",
      population_served_count > 100000 ~ "Very Large"),
    size_class = factor(size_class, levels = size_lvls)
  ) %>% 
  group_by(size_class) %>%
  # total count of tiers per state and size class
  mutate(size_class_count = n()) %>%
  ungroup() %>%
  group_by(size_class, tier) %>%
  # calculate count/proportion of tiers per state and size class
  summarise(
    count = n(),
    prop  = round(count/size_class_count,2)
  ) %>% 
  ungroup() %>% 
  distinct() %>% 
  # add missing NA values per state code and tier group
  complete(size_class, tier, 
           fill = list(count = 0, prop = 0)) %>%
  dt_make()
```

A data table of the the above plots, looking at Tier counts by primacy agency code, is provided below.

```{r datatable-temm-tier-distribution-per-state-and-system-size, echo = FALSE}
f_make_caption("datatable-temm-tier-distribution-per-state-and-system-size",
               "TEMM Tier distribution by system size and primacy agency code")

ag2 %>% 
  mutate(
    prop  = ifelse(is.na(prop), 0, prop),
    prop  = round(prop, 3)
  ) %>% 
  dt_make()
```

# *Explicit* boundaries

Tier 1 boundaries are the most straightforward to understand: states provide explicit data, and when they do, these boundaries tend to cover nearly the entire population served by water systems. Tier 1 data *missingness* challenges the accuracy of downstream Tier 2 and 3 boundary estimates. At the time of writing, Tier 1 data is present for `r wsb_labeled_clean$state %>% unique() %>% length()` states (`r wsb_labeled_clean$state %>% unique() %>% sort() %>% paste(collapse = ", ")`).

```{r tier-1-presence-absence, fig.cap = "Presence/absence of explicit boundaries in US"}
# summarize missing and present states in a dataframe
states_missing <- state.abb[!state.abb %in% unique(wsb_labeled_clean$state)]
states_present <- unique(wsb_labeled_clean$state)

states_df <- tibble(
  state_abbr = c(states_missing, states_present),
  status = c(rep("missing", length(states_missing)), 
             rep("present", length(states_present)))
)

# pull usa state geometries, project to input data CRS
usa <- USAboundaries::us_states(resolution = "low") %>% 
  st_transform(epsg) %>% 
  left_join(states_df) %>% 
  tigris::shift_geometry() %>% 
  # remove Puerto Rico
  filter(!is.na(status))

# map of missing states
ggplot() +
  geom_sf(data = usa, aes(fill = status), alpha = 0.5, color = "white") +
  scale_fill_carto_d(palette = "Pastel", direction = -1) +
  labs(fill = "") +
  theme_void() + 
  labs(title = "Labeled data coverage by state",
       subtitle = paste("Last updated:", Sys.Date()))
```


# Reviewing the "Pancake Problem"

```{r pancake-problem-query}
# filter for pancake stacks
pancakes <- a %>% 
  left_join(a %>%
              select(pwsid, tier, county_served)) %>%
  filter(centroid_quality == "ECHO: COUNTY CENTROID" & 
         tier == 3) 

# counties of big pancakes
big_pancakes <- pancakes %>% 
  count(county_served, primacy_agency_code, sort = TRUE) 

# plot
big_pancake_pwsid <- pancakes %>% 
  filter(county_served == big_pancakes$county_served[1] &
           primacy_agency_code == big_pancakes$primacy_agency_code[1]) %>% 
  pull(pwsid)
```

The "pancake problem" is fundamentally caused by low centroid accuracy (e.g., country or state centroid accuracy), and impacts PWSIDs that lack an explicit boundary (or TIGRIS match). Estimated radii for these systems result in circular buffers that overlap, like a stack of pancakes. To illustrate, we query for the biggest pancake problem (greatest number of pancakes in a single stack), which belongs to the county of `r big_pancakes$county_served[1]` in `r big_pancakes$primacy_agency_code[1]` and has `r length(big_pancake_pwsid)` Tier 3 predictions.

```{r pancake-problem-map}
# visualize
temm %>% 
  filter(pwsid %in% big_pancake_pwsid) %>% 
  mapview(zcol = "pwsid")

# calculate count and proportion of pancakes
nrow_tier3 <- temm %>% filter(tier == 3) %>% nrow()

pancake_count_prop <- temm %>% 
  st_drop_geometry() %>% 
  filter(tier == 3) %>%
  group_by(centroid_quality) %>% 
  summarise(
    count = n(),
    percent_tier3 = round((count/nrow_tier3), 3)*100
  ) %>% 
  arrange(desc(percent_tier3)) 
```

Next, we quantify the count and percent of "geometry quality" values for all **Tier 3** spatial boundaries. State centroid "geometry quality" (`r filter(pancake_count_prop, centroid_quality == "STATE CENTROID") %>% pull(percent_tier3)`% of Tier 3 data) is an extreme example of the centroid accuracy issues observed in the dataset. County centroids (`r filter(pancake_count_prop, centroid_quality == "COUNTY CENTROID") %>% pull(percent_tier3)`% of Tier 3 data) are more resolved than state-level centroids and are the most common scale at which pancake stacks form. Zip code centroids (`r filter(pancake_count_prop, centroid_quality == "ZIP CODE CENTROID") %>% pull(percent_tier3)`% of Tier 3 data) form a large proportion of Tier 3 data, but pancakes at this scale are not as inaccurate as county or state centroids and may be appropriately acceptable error for most analytical purposes. Finally, not all "geometry quality" values are associated with pancakes (for example, "GPS - UNSPECIFIED" points, when plotted, clearly do not form pancake stacks), but these make up a small proportion of Tier 3 data. Most Tier 3 systems suffer from the pancake problem. 

```{r count-pancakes-by-centroid-accuracy}
pancake_count_prop %>% 
  knitr::kable(col.names = c("Geometry Quality", 
                             "Count", 
                             "Percent"), 
               align = rep("l", 3),
               caption = "Geometry quality of centroids systems with Tier 3 boundary") %>% 
  kableExtra::kable_styling(full_width = FALSE)  
```